<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cliente em Foco</title>
<style>
  body { font-family: Arial; background: #f3f4f6; margin:0; padding:0; }
  header { background:#2563eb; color:white; padding:1rem; text-align:center; font-size:1.5rem; }
  main { display:flex; justify-content:space-around; padding:1rem; flex-wrap:wrap; }
  .column { width:30%; background:#e5e7eb; border-radius:10px; padding:10px; min-height:400px; margin-bottom:10px; }
  .card { background:white; border-radius:10px; padding:10px; margin-bottom:10px; box-shadow:0 2px 4px rgba(0,0,0,0.1); cursor:grab; }
  #newClientBtn { margin:10px; padding:10px 15px; background:#2563eb; color:white; border:none; border-radius:5px; cursor:pointer; }
  #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
  #modalContent { background:white; padding:20px; border-radius:10px; width:300px; max-height:90%; overflow-y:auto; }
  label,input,select,textarea { display:block; width:100%; margin-top:10px; padding:5px; border-radius:5px; border:1px solid #ccc; }
  #status { text-align:center; margin:10px; font-size:0.9rem; }
</style>
</head>
<body>

<header>Cliente em Foco</header>
<button id="newClientBtn">+ Novo Cliente</button>
<div id="status"></div>

<main>
  <div class="column" id="risco"><h2>⚠️ Risco</h2></div>
  <div class="column" id="critico"><h2>❗ Crítico</h2></div>
  <div class="column" id="duvidas"><h2>ℹ️ Dúvidas</h2></div>
</main>

<div id="modal">
  <div id="modalContent">
    <h3>Novo Cliente</h3>
    <input type="text" id="name" placeholder="Nome da Organização">
    <input type="text" id="members" placeholder="Integrantes">
    <input type="date" id="start">
    <input type="date" id="end">
    <textarea id="tickets" placeholder="Tickets"></textarea>
    <select id="divergenciaComercial"><option value="">Divergência Comercial?</option><option>Sim</option><option>Não</option></select>
    <select id="sistemaAnterior"><option value="">Sistema Anterior?</option><option>Sim</option><option>Não</option></select>
    <select id="atrasoImplantacao"><option value="">Atraso na Implantação?</option><option>Sim</option><option>Não</option></select>
    <input type="text" id="implantador" placeholder="Implantador">
    <textarea id="observacoes" placeholder="Observações"></textarea>
    <textarea id="tratativa" placeholder="Tratativa"></textarea>
    <button onclick="saveClient()">Salvar</button>
    <button onclick="closeModal()">Cancelar</button>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwCZVWXX6E32WR6SuKG0Q-CL4UMhViWWiRCCiTkzl8QtNfTchpYEsbY5-ci98QN5vxsUA/exec";

async function loadClients() {
  try {
    const res = await fetch(SCRIPT_URL);
    if (!res.ok) throw new Error("Erro ao acessar Web App");
    clients = await res.json();
    renderClients();
  } catch(err) {
    console.error(err);
    showStatus("Erro ao carregar clientes", "red");
  }
}


function showStatus(msg, color="black"){
  const el = document.getElementById("status");
  el.innerText = msg;
  el.style.color = color;
  setTimeout(()=> el.innerText="", 3000);
}

function openModal(){ document.getElementById("modal").style.display="flex"; }
function closeModal(){ document.getElementById("modal").style.display="none"; }

function saveClient() {
  const clientData = {
    id: Date.now(),
    name: document.getElementById("name").value,
    members: document.getElementById("members").value,
    start: document.getElementById("start").value,
    end: document.getElementById("end").value,
    tickets: document.getElementById("tickets").value,
    divergenciaComercial: document.getElementById("divergenciaComercial").value,
    sistemaAnterior: document.getElementById("sistemaAnterior").value,
    atrasoImplantacao: document.getElementById("atrasoImplantacao").value,
    implantador: document.getElementById("implantador").value,
    observacoes: document.getElementById("observacoes").value,
    tratativa: document.getElementById("tratativa").value,
    coluna: "duvidas"
  };

  showStatus("Salvando...", "blue");

  const formData = new FormData();
  formData.append("client", JSON.stringify(clientData));

  fetch(SCRIPT_URL, {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(json => {
    if (json.status === "ok") {
      showStatus("Salvo com sucesso ✅", "green");
      loadClients();
      closeModal();
    } else {
      showStatus("Erro ao salvar", "red");
    }
  })
  .catch(err => {
    console.error(err);
    showStatus("Erro de conexão", "red");
  });
}


function loadClients() {
  fetch(SCRIPT_URL)
    .then(async res => {
      const contentType = res.headers.get("content-type");
      const raw = await res.text();
      console.log("Resposta bruta:", raw);

      if (!contentType || !contentType.includes("application/json")) {
        showStatus("Resposta não é JSON", "red");
        throw new Error("Resposta não é JSON");
      }

      let data;
      try {
        data = JSON.parse(raw);
      } catch (err) {
        console.error("Erro ao interpretar JSON:", err);
        showStatus("Erro ao interpretar resposta", "red");
        return;
      }

      if (!Array.isArray(data)) {
        console.error("Resposta não é um array:", data);
        showStatus("Formato de dados inválido", "red");
        return;
      }

      clients = data;
      renderClients();
    })
    .catch(err => {
      console.error("Erro ao carregar clientes:", err);
      showStatus("Erro ao carregar clientes", "red");
    });
}





function allowDrop(ev){ ev.preventDefault(); }
function drag(ev){ draggedItem = ev.target; }

function drop(ev){
  ev.preventDefault();
  const column = ev.target.closest('.column');
  if(column && draggedItem){
    column.appendChild(draggedItem);
    const clientId = draggedItem.dataset.id;
    const client = clients.find(c=>c.id==clientId);
    if(!client) return;
    client.coluna = column.id;

    fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ client })
    })
    .then(res => res.json())
    .then(json => {
      if(json.status === "ok") {
        showStatus("Movido com sucesso ✅", "green");
        loadClients();
      } else {
        showStatus("Erro ao mover", "red");
      }
    })
    .catch(err => {
      console.error(err);
      showStatus("Erro ao mover", "red");
    });
  }
}

function renderClients(){
  const colNames = { risco:'⚠️ Risco', critico:'❗ Crítico', duvidas:'ℹ️ Dúvidas' };
  const colDesc  = { risco:'Clientes que podem cancelar', critico:'Clientes difíceis', duvidas:'Clientes com dúvidas ou implantação incompleta' };

  ["risco","critico","duvidas"].forEach(col=>{
    const column = document.getElementById(col);
    column.innerHTML = `<h2>${colNames[col]}</h2><p>${colDesc[col]}</p>`;
  });

  clients.forEach(client=>{
    if(!client || !client.id) return;
    const card = document.createElement("div");
    card.className="card";
    card.draggable=true;
    card.dataset.id=client.id;
    card.ondragstart=drag;
    card.innerHTML=`<strong>${client.name}</strong><br>
      Integrantes: ${client.members||"-"}<br>
      Início: ${client.start||"-"} | Fim: ${client.end||"-"}<br>
      <div><strong>Tickets:</strong><br>${client.tickets||"-"}</div>
      <div><strong>Observações:</strong><br>${client.observacoes||"-"}</div>
      <div><strong>Tratativa:</strong><br>${client.tratativa||"-"}</div>
      Implantador: ${client.implantador||"-"}`;
    document.getElementById(client.coluna||"duvidas").appendChild(card);
  });
}

document.getElementById("newClientBtn").addEventListener("click",openModal);
document.querySelectorAll(".column").forEach(col=>{
  col.addEventListener("dragover",allowDrop);
  col.addEventListener("drop",drop);
});

loadClients();
</script>

</body>
</html>
