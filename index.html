<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <link rel="icon" type="image/png" href="lexos_favicon.png">

<meta charset="UTF-8">
<title>Cliente em Foco</title>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<style>
  html, body { height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif; }
  body { display: flex; background-color: #f3f4f6; min-height: 100vh; }

  #sidebar {
    width: 60px; background: #0043f8; color: white; padding-top: 20px;
    position: fixed; top: 0; left: 0; bottom: 0; overflow: hidden; transition: width 0.3s; z-index: 1000;
  }
  #sidebar:hover { width: 220px; }
  #sidebar button {
    display: block; width: 90%; margin: 10px auto; padding: 10px;
    border: none; border-radius: 5px; cursor: pointer; background: #0024ee; color: white;
    text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  #mainContent {
    padding: 20px; min-height: 100vh; display: flex; flex-direction: column; align-items: stretch;
    width: calc(100% - 60px); margin-left: 60px; box-sizing: border-box;
    transition: width 0.3s, margin-left 0.3s;
  }
  #sidebar:hover ~ #mainContent { width: calc(100% - 220px); margin-left: 220px; }

  header { background-color: #0043f8; color: white; padding: 15px; font-size: 24px; text-align: center; margin: 0 0 20px 0; border-radius: 8px; }
  main { display: flex; justify-content: space-between; gap: 20px; flex-wrap: nowrap; width: 100%; }

  .column { flex: 1; min-width: 250px; background: #fff; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 10px; }
  .column h2 { text-align: center; }

  .card { background: #e5e7eb; border-radius: 6px; padding: 15px; margin: 10px 0; cursor: grab; font-size: 16px; word-wrap: break-word; overflow-wrap: break-word; }
  .card .details { display: none; } .card.dragging { opacity: 0.5; }

  button.actionBtn { margin: 5px 3px; padding: 5px 8px; border: none; border-radius: 5px; cursor: pointer; }
  .toggleBtn { background-color: #4caf50; color: white; }
  .editBtn { background-color: #2196f3; color: white; }
  .deleteBtn { background-color: #f44336; color: white; }

  #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
  #modalContent { background: white; padding: 20px; border-radius: 10px; width: 400px; max-height: 90vh; overflow-y: auto; }

  input, select, textarea { width: 100%; margin-bottom: 8px; padding: 7px; border-radius: 4px; border: 1px solid #ccc; }
  #searchInput, #searchClientes { padding: 6px; margin-bottom: 15px; width: 250px; border-radius: 5px; border: 1px solid #ccc; }
  table { width:100%; border-collapse: collapse; margin-top:10px; }
  th, td { border:1px solid #ccc; padding:8px; text-align:left; }
</style>
</head>
<body>

<div id="sidebar">
  <button onclick="showModule('cards')">üìã Cards</button>
  <button onclick="showModule('clientes')">üë• Clientes</button>
</div>

<div id="mainContent">
  <header>Cliente em Foco</header>

  <div id="cardsModule">
    <div style="text-align:center; margin-bottom:15px;">
      <button onclick="openModal(null,true)">+ Novo Card</button>
      <button onclick="exportKanbanToCSV()">Exportar CSV</button>
      <input type="text" id="searchInput" placeholder="Pesquisar cards..." oninput="renderKanban()">
    </div>
    <main>
      <div class="column" id="risco"><h2>‚ö†Ô∏è Risco de Cancelamento</h2></div>
      <div class="column" id="critico"><h2>‚ùó Cr√≠ticos</h2></div>
      <div class="column" id="acompanhamento"><h2>üìÜ Acompanhamento</h2></div>
      <div class="column" id="duvidas"><h2>‚ÑπÔ∏è D√∫vidas</h2></div>
      <div class="column" id="concluido"><h2>‚úÖ Conclu√≠do</h2></div>
    </main>
  </div>

  <div id="clientesModule" style="display:none;">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
      <label for="excelFile" style="background:#2563eb; color:white; padding:8px 12px; border-radius:5px; cursor:pointer;">Escolher arquivo</label>
      <input type="file" id="excelFile" accept=".xlsx, .xls" style="display:none;">
      <button onclick="importExcel()" style="background:#2563eb; color:white; padding:8px 12px; border:none; border-radius:5px;">Importar Excel</button>
      <button onclick="exportClientesToCSV()" style="background:#2563eb; color:white; padding:8px 12px; border:none; border-radius:5px;">Exportar CSV</button>
      <button onclick="deleteAllClients()" style="background:#f44336; color:white; padding:8px 12px; border:none; border-radius:5px;">Apagar todos</button>
    </div>
    <div style="text-align:center; margin-bottom:10px;">
      <button onclick="openModal(null,false)" style="background:#2563eb; color:white; padding:10px 20px; border:none; border-radius:5px;">+ Adicionar Cliente</button>
    </div>
    <input type="text" id="searchClientes" placeholder="Pesquisar clientes..." oninput="renderClientes()">
    <table>
      <thead>
        <tr><th>Organiza√ß√£o</th><th>Coluna</th><th>A√ß√µes</th></tr>
      </thead>
      <tbody id="clientesTableBody"></tbody>
    </table>
  </div>
</div>

<div id="modal">
  <div id="modalContent">
    <h3 id="modalTitle">Novo Cliente</h3>
    <input type="text" id="clientName" placeholder="Organiza√ß√£o">
    <input type="text" id="clientMembers" placeholder="Integrantes">
    <input type="date" id="clientStart" placeholder="Data de in√≠cio">
    <input type="date" id="clientEnd" placeholder="Data Go live">
    <textarea id="clientTickets" placeholder="Tickets"></textarea>
    <textarea id="clientObservacoes" placeholder="Observa√ß√µes"></textarea>
    <textarea id="clientTratativa" placeholder="Tratativa"></textarea>
    <select id="clientReuniao">
      <option value="">Reuni√£o marcada?</option><option>Sim</option><option>N√£o</option>
    </select>
    <input type="date" id="clientDataReuniao" placeholder="Data reuni√£o">
    <select id="clientDivergenciaComercial">
      <option value="">Diverg√™ncia Comercial?</option><option>Sim</option><option>N√£o</option>
    </select>
    <select id="clientAtrasoImplantacao">
      <option value="">Atraso implanta√ß√£o?</option><option>Sim</option><option>N√£o</option>
    </select>
    <input type="text" id="clientImplantador" placeholder="Implantador">
    <select id="clientColuna">
      <option value="">Sem coluna</option>
      <option value="risco">Risco de Cancelamento</option>
      <option value="critico">Cr√≠ticos</option>
      <option value="acompanhamento">Acompanhamento</option>
      <option value="duvidas">D√∫vidas</option>
      <option value="concluido">Conclu√≠do</option>
    </select>
    <button onclick="saveClient(currentIsCard)">Salvar</button>
    <button onclick="closeModal()">Cancelar</button>
  </div>
</div>
<script>
let clients = JSON.parse(localStorage.getItem("kanbanClients") || "[]");
let editingClient = null;
let currentIsCard = true;
const SHEET_URL = "https://script.google.com/macros/s/AKfycbz_ii7VgsUnPLtNkvrcp3Q9ATIaPM_LgAEZaeoHqGoJdDLJCkbuFUFc1C2zUkiIlXRxDw/exec"; // webapi

function showModule(module){
  document.getElementById('cardsModule').style.display = module==='cards'? 'block':'none';
  document.getElementById('clientesModule').style.display = module==='clientes'? 'block':'none';
  renderKanban(); renderClientes();
}

// üîπ Helpers de data
function formatDateInput(value){
  if(!value) return "";
  // Se j√° for string no formato YYYY-MM-DD, retorna como est√°
  if(typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value)) return value;
  // Se for Date, monta YYYY-MM-DD sem alterar fuso (usa getFullYear/getMonth/getDate)
  if(value instanceof Date && !isNaN(value)){
    const y = value.getFullYear();
    const m = String(value.getMonth()+1).padStart(2,'0');
    const d = String(value.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  // Tenta criar Date ‚Äî pode falhar com strings sem padr√£o; se falhar, retorna ""
  const d = new Date(value);
  if(isNaN(d)) return "";
  return d.toISOString().split("T")[0]; // fallback
}

// ‚úÖ Formata√ß√£o para exibi√ß√£o (evita problema de timezone)
function formatDisplayDate(dateInput){
  if(!dateInput) return "-";
  // Se for string no formato YYYY-MM-DD
  if(typeof dateInput === 'string'){
    const m = dateInput.match(/(\d{4})-(\d{2})-(\d{2})/);
    if(m) return `${m[3]}/${m[2]}/${m[1]}`;
    // Se estiver em formato dd/mm/yyyy (por acaso), retorna direto
    const m2 = dateInput.match(/(\d{2})\/(\d{2})\/(\d{4})/);
    if(m2) return `${m2[1]}/${m2[2]}/${m2[3]}`;
    // fallback: tenta Date (√∫ltimo recurso)
    const d = new Date(dateInput);
    if(!isNaN(d)) return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
    return "-";
  }
  // Se for Date object
  if(dateInput instanceof Date && !isNaN(dateInput)){
    return `${String(dateInput.getDate()).padStart(2,'0')}/${String(dateInput.getMonth()+1).padStart(2,'0')}/${dateInput.getFullYear()}`;
  }
  return "-";
}

// üîπ Google Sheets
function saveClientToSheet(client){
  fetch(SHEET_URL,{
    method:"POST",
    body: JSON.stringify(client)
  }).then(res=>res.json())
    .then(res=>console.log("Salvo na planilha!", res))
    .catch(err=>console.error("Erro ao salvar na planilha", err));
}

function loadClientsFromSheet(){
  fetch(SHEET_URL)
    .then(res=>res.json())
    .then(data=>{
      data.forEach(sheetClient => {
        const existing = clients.find(c=>c.clientName===sheetClient.clientName);
        if(existing){
          Object.assign(existing, sheetClient);
        } else {
          clients.push({...sheetClient, id: Date.now().toString()+Math.random()});
        }
      });
      localStorage.setItem("kanbanClients", JSON.stringify(clients));
      renderKanban();
      renderClientes();
    })
    .catch(err=>console.error("Erro ao carregar da planilha", err));
}

// üîπ Importar Excel
function importExcel() {
  const file = document.getElementById("excelFile").files[0];
  if (!file) { alert("Selecione um arquivo Excel primeiro."); return; }

  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

    sheet.forEach(row => {
      const clientData = {
        clientName: row["Organiza√ß√£o"]?.trim() || "",
        clientMembers: row["Integrantes"]?.trim() || "",
        clientStart: formatDateInput(row["Data in√≠cio"]),
        clientEnd: formatDateInput(row["Data Go live"]),
        clientTickets: row["Tickets"]?.trim() || "",
        clientObservacoes: row["Observa√ß√µes"]?.trim() || "",
        clientTratativa: row["Tratativa"]?.trim() || "",
        clientReuniao: row["Reuni√£o marcada?"]?.trim() || "",
        clientDataReuniao: formatDateInput(row["Data reuni√£o"]),
        clientDivergenciaComercial: row["Diverg√™ncia Comercial?"]?.trim() || "",
        clientAtrasoImplantacao: row["Atraso implanta√ß√£o?"]?.trim() || "",
        clientImplantador: row["Implantador"]?.trim() || "",
        clientColuna: row["Coluna"]?.trim() || ""
      };

      // üîπ Envia sempre para a planilha
      saveClientToSheet(clientData);

      // üîπ Evita duplicidade no site
      const existing = clients.find(c => c.clientName.trim().toLowerCase() === clientData.clientName.toLowerCase());
      if (!existing) {
        clientData.id = Date.now().toString() + Math.random();
        clients.push(clientData);
      } else {
        Object.assign(existing, clientData);
      }
    });

    localStorage.setItem("kanbanClients", JSON.stringify(clients));
    renderKanban();
    renderClientes();
    alert("Clientes importados e enviados para a planilha com sucesso!");
  };

  reader.readAsArrayBuffer(file);
}

// üîπ Exportar Cards para CSV
function exportKanbanToCSV() {
  const columns = ["risco","critico","acompanhamento","duvidas","concluido"];
  let csv = "Nome,Integrantes,Data In√≠cio,Go live,Tickets,Observa√ß√µes,Tratativa,Implantador,Coluna\n";

  clients.filter(c => c.clientColuna).forEach(c => {
    const row = [
      `"${c.clientName}"`,
      `"${c.clientMembers}"`,
      `"${c.clientStart}"`,
      `"${c.clientEnd}"`,
      `"${c.clientTickets}"`,
      `"${c.clientObservacoes}"`,
      `"${c.clientTratativa}"`,
      `"${c.clientImplantador}"`,
      `"${c.clientColuna}"`
    ];
    csv += row.join(",") + "\n";
  });

  downloadCSV(csv, "cards.csv");
}
// üîπ Fun√ß√µes de exporta√ß√£o CSV (compat√≠vel com Excel PT-BR)
function exportKanbanToCSV() {
  let csv = "Nome;Integrantes;Data In√≠cio;Go live;Tickets;Observa√ß√µes;Tratativa;Implantador;Coluna\n";
  clients.filter(c => c.clientColuna).forEach(c => {
    const row = [
      `"${c.clientName || ""}"`,
      `"${c.clientMembers || ""}"`,
      `"${c.clientStart || ""}"`,
      `"${c.clientEnd || ""}"`,
      `"${c.clientTickets || ""}"`,
      `"${c.clientObservacoes || ""}"`,
      `"${c.clientTratativa || ""}"`,
      `"${c.clientImplantador || ""}"`,
      `"${c.clientColuna || ""}"`
    ];
    csv += row.join(";") + "\n";
  });
  downloadCSV(csv, "cards.csv");
}

function exportClientesToCSV() {
  let csv = "Nome;Integrantes;Data In√≠cio;Go live;Tickets;Observa√ß√µes;Tratativa;Implantador;Coluna\n";
  clients.forEach(c => {
    const row = [
      `"${c.clientName || ""}"`,
      `"${c.clientMembers || ""}"`,
      `"${c.clientStart || ""}"`,
      `"${c.clientEnd || ""}"`,
      `"${c.clientTickets || ""}"`,
      `"${c.clientObservacoes || ""}"`,
      `"${c.clientTratativa || ""}"`,
      `"${c.clientImplantador || ""}"`,
      `"${c.clientColuna || ""}"`
    ];
    csv += row.join(";") + "\n";
  });
  downloadCSV(csv, "clientes.csv");
}

function downloadCSV(csvContent, fileName) {
  const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" }); // BOM para acentua√ß√£o correta
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  link.href = url;
  link.download = fileName;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// üîπ Modal e salvar
function openModal(client=null, isCard=true){
  editingClient = client;
  currentIsCard = isCard;
  document.getElementById("modal").style.display = "flex";
  document.getElementById("modalTitle").innerText = client ? "Editar Cliente" : "Novo Cliente";

  document.getElementById("clientName").value = client?.clientName || "";
  document.getElementById("clientMembers").value = client?.clientMembers || "";
  document.getElementById("clientStart").value = formatDateInput(client?.clientStart);
  document.getElementById("clientEnd").value = formatDateInput(client?.clientEnd);
  document.getElementById("clientTickets").value = client?.clientTickets || "";
  document.getElementById("clientObservacoes").value = client?.clientObservacoes || "";
  document.getElementById("clientTratativa").value = client?.clientTratativa || "";
  document.getElementById("clientReuniao").value = client?.clientReuniao || "";
  document.getElementById("clientDataReuniao").value = formatDateInput(client?.clientDataReuniao);
  document.getElementById("clientDivergenciaComercial").value = client?.clientDivergenciaComercial || "";
  document.getElementById("clientAtrasoImplantacao").value = client?.clientAtrasoImplantacao || "";
  document.getElementById("clientImplantador").value = client?.clientImplantador || "";
  document.getElementById("clientColuna").value = client?.clientColuna || "";
}

function closeModal(){ document.getElementById("modal").style.display="none"; editingClient=null; }

function saveClient(isCard){
  const clientData = {
    id: editingClient?.id || Date.now().toString(),
    clientName: clientName.value,
    clientMembers: clientMembers.value,
    clientStart: formatDateInput(clientStart.value),
    clientEnd: formatDateInput(clientEnd.value),
    clientTickets: clientTickets.value,
    clientObservacoes: clientObservacoes.value,
    clientTratativa: clientTratativa.value,
    clientReuniao: clientReuniao.value,
    clientDataReuniao: formatDateInput(clientDataReuniao.value),
    clientDivergenciaComercial: clientDivergenciaComercial.value,
    clientAtrasoImplantacao: clientAtrasoImplantacao.value,
    clientImplantador: clientImplantador.value,
    clientColuna: clientColuna.value
  };

  if(editingClient){
    const index = clients.findIndex(c => c.id === editingClient.id);
    if(index !== -1) clients[index] = clientData;
  } else {
    clients.push(clientData);
  }

  localStorage.setItem("kanbanClients", JSON.stringify(clients));
  saveClientToSheet(clientData);
  closeModal();
  renderKanban();
  renderClientes();
}

// üîπ Renderiza√ß√µes
function deleteClient(id){
  if(confirm("Deseja realmente excluir este cliente?")){
    clients=clients.filter(c=>c.id!==id);
    localStorage.setItem("kanbanClients", JSON.stringify(clients));
    renderKanban(); renderClientes();
  }
}

function renderKanban(){
  const searchTerm = (searchInput?.value || "").toLowerCase();
  const columns = ["risco","critico","acompanhamento","duvidas","concluido"];

  columns.forEach(col=>{
    const column = document.getElementById(col);
    const title = column.querySelector('h2').innerText;
    column.innerHTML = `<h2>${title}</h2>`;
    column.addEventListener("dragover", e => e.preventDefault());
    column.addEventListener("drop", e => {
      e.preventDefault();
      const cardId = e.dataTransfer.getData("text/plain");
      const card = clients.find(c => c.id === cardId);
      if(card){ 
        card.clientColuna = col;
        localStorage.setItem("kanbanClients", JSON.stringify(clients));
        saveClientToSheet(card);
        renderKanban(); renderClientes(); 
      }
    });
  });

  clients
    .filter(c => c.clientColuna)
    .filter(c => {
      const all = [
        c.clientName, c.clientMembers, c.clientTickets, 
        c.clientObservacoes, c.clientTratativa, c.clientImplantador
      ].join(" ").toLowerCase();
      return all.includes(searchTerm);
    })
    .forEach(client => {
      const card = document.createElement("div");
      card.className = "card";
      card.dataset.id = client.id;
      card.draggable = true;

      card.innerHTML = `
        <strong>${client.clientName}</strong>
        <button class="toggleBtn">Mostrar mais</button>
        <div class="details" style="display:none; margin-top:10px;">
          <p><b>Integrantes:</b> ${client.clientMembers || "-"}</p>
          <p><b>Data in√≠cio:</b> ${formatDisplayDate(client.clientStart)}</p>
          <p><b>Go live:</b> ${formatDisplayDate(client.clientEnd)}</p>
          <p><b>Tickets:</b> ${client.clientTickets || "-"}</p>
          <p><b>Observa√ß√µes:</b> ${client.clientObservacoes || "-"}</p>
          <p><b>Tratativa:</b> ${client.clientTratativa || "-"}</p>
          <p><b>Implantador:</b> ${client.clientImplantador || "-"}</p>
          <div style="display:flex; gap:8px; margin-top:10px;">
            <button class="editBtn">Editar</button>
            <button class="deleteBtn">Excluir</button>
          </div>
        </div>
      `;

      // üîπ Evento de clique no card para abrir/fechar detalhes
      card.addEventListener("click", (e) => {
        // Evita conflito com o bot√£o Mostrar mais
        if (e.target.classList.contains("toggleBtn")) return;
        const details = card.querySelector(".details");
        const toggle = card.querySelector(".toggleBtn");
        const isVisible = details.style.display === "block";
        details.style.display = isVisible ? "none" : "block";
        toggle.innerText = isVisible ? "Mostrar mais" : "Mostrar menos";
      });

      // üîπ Bot√µes internos
      card.querySelector(".toggleBtn").addEventListener("click", (e)=>{
        e.stopPropagation();
        const d = card.querySelector(".details");
        const isVisible = d.style.display === "block";
        d.style.display = isVisible ? "none" : "block";
        e.target.innerText = isVisible ? "Mostrar mais" : "Mostrar menos";
      });

      card.querySelector(".editBtn").addEventListener("click", (e)=>{
        e.stopPropagation();
        openModal(client,true);
      });

      card.querySelector(".deleteBtn").addEventListener("click", (e)=>{
        e.stopPropagation();
        deleteClient(client.id);
      });

      card.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/plain", client.id);
        card.classList.add("dragging");
      });
      card.addEventListener("dragend", ()=>card.classList.remove("dragging"));

      document.getElementById(client.clientColuna)?.appendChild(card);
    });
}


function renderClientes(){
  const tbody=document.getElementById("clientesTableBody");
  tbody.innerHTML="";
  clients.filter(c=>c.clientName.toLowerCase().includes((searchClientes?.value||"").toLowerCase())).forEach(c=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${c.clientName}</td>
      <td>
        <select onchange="updateClientColuna('${c.id}',this.value)">
          <option value="" ${c.clientColuna===""?"selected":""}>Sem coluna</option>
          <option value="risco" ${c.clientColuna==="risco"?"selected":""}>Risco de Cancelamento</option>
          <option value="critico" ${c.clientColuna==="critico"?"selected":""}>Cr√≠ticos</option>
          <option value="acompanhamento" ${c.clientColuna==="acompanhamento"?"selected":""}>Acompanhamento</option>
          <option value="duvidas" ${c.clientColuna==="duvidas"?"selected":""}>D√∫vidas</option>
          <option value="concluido" ${c.clientColuna==="concluido"?"selected":""}>Conclu√≠do</option>
        </select>
      </td>
      <td>
        <button onclick="openModal(clients.find(c=>c.id==='${c.id}'),false)">Editar</button>
        <button onclick="deleteClient('${c.id}')">Excluir</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function updateClientColuna(id,value){
  const client = clients.find(c => c.id === id);
  if(client){
    client.clientColuna = value;
    localStorage.setItem("kanbanClients", JSON.stringify(clients));
    saveClientToSheet(client);
    renderKanban();
    renderClientes();
  }
}

function deleteAllClients(){
  if(confirm("Tem certeza que deseja apagar TODOS os clientes? Essa a√ß√£o n√£o pode ser desfeita.")){
    clients = [];
    localStorage.removeItem("kanbanClients");
    renderKanban();
    renderClientes();
    alert("Todos os clientes foram apagados com sucesso.");
  }
}

showModule('cards');
loadClientsFromSheet();
</script>
</body>
</html>
