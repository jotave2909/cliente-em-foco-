<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cliente em Foco</title>
<style>
  body { font-family: Arial, sans-serif; background-color: #f3f4f6; margin: 0; padding: 0; }
  header { background-color: #2563eb; color: white; padding: 10px; font-size: 20px; text-align: center; }
  main { display: flex; justify-content: space-around; padding: 10px; }
  .column { background: #fff; border-radius: 8px; padding: 10px; width: 30%; min-height: 300px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  .column h2 { text-align: center; }
  .card { background: #e5e7eb; border-radius: 6px; padding: 10px; margin: 8px 0; cursor: grab; word-wrap: break-word; }
  .card.dragging { opacity: 0.5; }
  .card strong { display: block; margin-bottom: 6px; }
  button { margin: 5px 3px; padding: 5px 8px; border: none; border-radius: 5px; cursor: pointer; }
  .toggleBtn { background-color: #4caf50; color: white; }
  .editBtn { background-color: #2196f3; color: white; }
  .deleteBtn { background-color: #f44336; color: white; }
  #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
  #modalContent { background: white; padding: 20px; border-radius: 10px; width: 400px; max-height: 90vh; overflow-y: auto; }
  input, select, textarea { width: 100%; margin-bottom: 5px; padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
</style>
</head>
<body>

<header>Cliente em Foco</header>
<div style="text-align:center; margin:10px;">
  <button onclick="openModal()">+ Novo Card</button>
  <button onclick="exportKanbanToCSV()">Exportar CSV</button>
</div>

<main>
  <div class="column" id="risco"><h2>⚠️ Risco de Cancelamento</h2></div>
  <div class="column" id="critico"><h2>❗ Críticos</h2></div>
  <div class="column" id="duvidas"><h2>ℹ️ Dúvidas</h2></div>
</main>

<div id="modal">
  <div id="modalContent">
    <h3 id="modalTitle">Novo Card</h3>
    <input type="text" id="clientName" placeholder="Organização">
    <input type="text" id="clientMembers" placeholder="Integrantes">
    <input type="date" id="clientStart" placeholder="Data de início">
    <input type="date" id="clientEnd" placeholder="Data Go live">
    <textarea id="clientTickets" placeholder="Tickets"></textarea>
    <textarea id="clientObservacoes" placeholder="Observações"></textarea>
    <textarea id="clientTratativa" placeholder="Tratativa"></textarea>
    <select id="clientReuniao">
      <option value="">Reunião marcada?</option>
      <option>Sim</option>
      <option>Não</option>
    </select>
    <input type="date" id="clientDataReuniao" placeholder="Data reunião">
    <select id="clientDivergenciaComercial">
      <option value="">Divergência Comercial?</option>
      <option>Sim</option>
      <option>Não</option>
    </select>
    <select id="clientAtrasoImplantacao">
      <option value="">Atraso implantação?</option>
      <option>Sim</option>
      <option>Não</option>
    </select>
    <input type="text" id="clientImplantador" placeholder="Implantador">
    <select id="clientColuna">
      <option value="risco">Risco de Cancelamento</option>
      <option value="critico">Críticos</option>
      <option value="duvidas">Dúvidas</option>
    </select>
    <button onclick="saveClient()">Salvar</button>
    <button onclick="closeModal()">Cancelar</button>
  </div>
</div>

<script>
let clients = JSON.parse(localStorage.getItem("kanbanClients") || "[]");
let editingClient = null;

function openModal(client=null){
  editingClient = client;
  document.getElementById("modal").style.display="flex";
  document.getElementById("modalTitle").innerText = client ? "Editar Card" : "Novo Card";
  ["clientName","clientMembers","clientStart","clientEnd","clientTickets","clientObservacoes","clientTratativa","clientReuniao","clientDataReuniao","clientDivergenciaComercial","clientAtrasoImplantacao","clientImplantador","clientColuna"].forEach(id=>{
    document.getElementById(id).value = client?.[id] || "";
  });
}

function closeModal(){
  document.getElementById("modal").style.display="none";
  editingClient = null;
}

function saveClient(){
  const clientData = {
    id: editingClient?.id || Date.now().toString(),
    clientName: document.getElementById("clientName").value,
    clientMembers: document.getElementById("clientMembers").value,
    clientStart: document.getElementById("clientStart").value,
    clientEnd: document.getElementById("clientEnd").value,
    clientTickets: document.getElementById("clientTickets").value,
    clientObservacoes: document.getElementById("clientObservacoes").value,
    clientTratativa: document.getElementById("clientTratativa").value,
    clientReuniao: document.getElementById("clientReuniao").value,
    clientDataReuniao: document.getElementById("clientDataReuniao").value,
    clientDivergenciaComercial: document.getElementById("clientDivergenciaComercial").value,
    clientAtrasoImplantacao: document.getElementById("clientAtrasoImplantacao").value,
    clientImplantador: document.getElementById("clientImplantador").value,
    clientColuna: document.getElementById("clientColuna").value || "critico"
  };
  
  if(editingClient){
    const index = clients.findIndex(c => c.id === clientData.id);
    if(index !== -1) clients[index] = clientData;
  } else {
    clients.push(clientData);
  }

  localStorage.setItem("kanbanClients", JSON.stringify(clients));
  closeModal();
  renderKanban();
}

function deleteClient(id){
  if(confirm("Deseja realmente excluir este card?")){
    clients = clients.filter(c=>c.id!==id);
    localStorage.setItem("kanbanClients", JSON.stringify(clients));
    renderKanban();
  }
}

function renderKanban(){
  ["risco","critico","duvidas"].forEach(col=>{
    const column = document.getElementById(col);
    const title = column.querySelector('h2').innerText;
    column.innerHTML = `<h2>${title}</h2>`;
    column.addEventListener("dragover", e => e.preventDefault());
    column.addEventListener("drop", e => {
      e.preventDefault();
      const cardId = e.dataTransfer.getData("text/plain");
      const card = clients.find(c=>c.id===cardId);
      if(card){
        card.clientColuna = col;
        localStorage.setItem("kanbanClients", JSON.stringify(clients));
        renderKanban();
      }
    });
  });
  
  clients.forEach(client=>{
    const card = document.createElement("div");
    card.className="card";
    card.dataset.id = client.id;
    card.draggable = true;
    card.innerHTML = `
      <strong>${client.clientName}</strong>
      <div class="details" style="display:none;">
        <p><b>Integrantes:</b> ${client.clientMembers||"-"}</p>
        <p><b>Período:</b> ${client.clientStart||"-"} → ${client.clientEnd||"-"}</p>
        <p><b>Tickets:</b> ${client.clientTickets||"-"}</p>
        <p><b>Observações:</b> ${client.clientObservacoes||"-"}</p>
        <p><b>Tratativa:</b> ${client.clientTratativa||"-"}</p>
        <p><b>Reunião marcada:</b> ${client.clientReuniao||"-"}</p>
        <p><b>Data reunião:</b> ${client.clientDataReuniao||"-"}</p>
        <p><b>Divergência Comercial:</b> ${client.clientDivergenciaComercial||"-"}</p>
        <p><b>Atraso Implantação:</b> ${client.clientAtrasoImplantacao||"-"}</p>
        <p><b>Implantador:</b> ${client.clientImplantador||"-"}</p>
      </div>
      <button class="toggleBtn">Mostrar mais</button>
      <button class="editBtn">Editar</button>
      <button class="deleteBtn">Excluir</button>
    `;
    
    card.addEventListener("dragstart", e => {
      e.dataTransfer.setData("text/plain", client.id);
      card.classList.add("dragging");
    });
    card.addEventListener("dragend", e => card.classList.remove("dragging"));
    
    card.querySelector(".toggleBtn").addEventListener("click", ()=>{
      const d = card.querySelector(".details");
      d.style.display = d.style.display==="none"?"block":"none";
      card.querySelector(".toggleBtn").innerText = d.style.display==="none"?"Mostrar mais":"Mostrar menos";
    });
    
    card.querySelector(".editBtn").addEventListener("click",()=>openModal(client));
    card.querySelector(".deleteBtn").addEventListener("click",()=>deleteClient(client.id));
    
    const columnEl = document.getElementById(client.clientColuna);
    if(columnEl) columnEl.appendChild(card);
  });
}

// === FUNÇÃO CSV ATUALIZADA PARA COLUNAS CORRETAS ===
function exportKanbanToCSV(){
  if(clients.length===0){ alert("Nenhum card para exportar!"); return; }

  const headers = ["Organização","Integrantes","Data Início","Data Go Live","Tickets","Observações","Tratativa","Reunião","Data Reunião","Divergência Comercial","Atraso Implantação","Implantador","Coluna"];
  const csvRows = [headers.map(h => `"${h}"`).join(";")];

  clients.forEach(c => {
    const row = [
      c.clientName,
      c.clientMembers,
      c.clientStart,
      c.clientEnd,
      c.clientTickets,
      c.clientObservacoes,
      c.clientTratativa,
      c.clientReuniao,
      c.clientDataReuniao,
      c.clientDivergenciaComercial,
      c.clientAtrasoImplantacao,
      c.clientImplantador,
      c.clientColuna
    ].map(field => `"${(field||"").toString().replace(/"/g,'""')}"`);
    csvRows.push(row.join(";"));
  });

  const blob = new Blob([csvRows.join("\r\n")], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "clientes.csv";
  a.click();
  URL.revokeObjectURL(url);
}

renderKanban();
</script>

</body>
</html>
