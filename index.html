<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cliente em Foco</title>
<!-- SheetJS para importar Excel -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
  }

  body {
    display: flex;
    background-color: #f3f4f6;
    min-height: 100vh;
  }

  /* Sidebar retr√°til fixa */
  #sidebar {
    width: 60px;
    background: #0043f8;
    color: white;
    padding-top: 20px;
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    overflow: hidden;
    transition: width 0.3s;
    z-index: 1000;
  }

  #sidebar:hover {
    width: 220px;
  }

  #sidebar button {
    display: block;
    width: 90%;
    margin: 10px auto;
    padding: 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    background: #0024ee;
    color: white;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Conte√∫do principal */
  #mainContent {
    padding: 20px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    width: calc(100% - 60px);
    margin-left: 60px;
    box-sizing: border-box;
    transition: width 0.3s, margin-left 0.3s;
  }

  #sidebar:hover ~ #mainContent {
    width: calc(100% - 220px);
    margin-left: 220px;
  }

  header {
    background-color: #2563eb;
    color: white;
    padding: 15px;
    font-size: 24px;
    text-align: center;
    margin: 0 0 20px 0;
    line-height: normal;
    border-radius: 8px;
  }

  /* Main dentro do cards */
  main {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    flex-wrap: nowrap;
    width: 100%;
  }

  /* Colunas */
  .column {
    flex: 1;
    min-width: 250px;
    max-width: 100%;
    background: #fff;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    gap: 10px;
    box-sizing: border-box;
  }

  .column h2 {
    text-align: center;
  }

  /* Cards */
  .card {
    background: #e5e7eb;
    border-radius: 6px;
    padding: 15px;
    margin: 10px 0;
    cursor: grab;
    font-size: 16px;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    word-wrap: break-word;
    overflow-wrap: break-word;
    overflow: hidden;
  }

  .card .details {
    display: none;
    overflow-wrap: break-word;
    word-wrap: break-word;
  }

  .card.dragging {
    opacity: 0.5;
  }

  .card strong {
    display: block;
    margin-bottom: 6px;
  }

  button.actionBtn {
    margin: 5px 3px;
    padding: 5px 8px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }

  .toggleBtn { background-color: #4caf50; color: white; }
  .editBtn { background-color: #2196f3; color: white; }
  .deleteBtn { background-color: #f44336; color: white; }

  #modal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
  }

  #modalContent {
    background: white;
    padding: 20px;
    border-radius: 10px;
    width: 400px;
    max-height: 90vh;
    overflow-y: auto;
  }

  input, select, textarea {
    width: 100%;
    margin-bottom: 8px;
    padding: 7px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }

  #searchInput, #searchClientes {
    padding: 6px;
    margin-bottom: 15px;
    width: 250px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }

  table {
    width:100%;
    border-collapse: collapse;
    margin-top:10px;
  }

  th, td {
    border:1px solid #ccc;
    padding:8px;
    text-align:left;
  }
</style>
</head>
<body>

<div id="sidebar">
  <button onclick="showModule('cards')">üìã Cards</button>
  <button onclick="showModule('clientes')">üë• Clientes</button>
</div>

<div id="mainContent">
  <header>Cliente em Foco</header>

  <!-- Cards Module -->
  <div id="cardsModule">
    <div style="text-align:center; margin-bottom:15px;">
      <button onclick="openModal(null,true)">+ Novo Card</button>
      <button onclick="exportKanbanToCSV()">Exportar CSV</button>
      <input type="text" id="searchInput" placeholder="Pesquisar cards..." oninput="renderKanban()">
    </div>
    <main>
      <div class="column" id="risco"><h2>‚ö†Ô∏è Risco de Cancelamento</h2></div>
      <div class="column" id="critico"><h2>‚ùó Cr√≠ticos</h2></div>
      <div class="column" id="duvidas"><h2>‚ÑπÔ∏è D√∫vidas</h2></div>
    </main>
  </div>

  <!-- Clientes Module -->
  <div id="clientesModule" style="display:none;">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
      <label for="excelFile" style="background:#2563eb; color:white; padding:8px 12px; border-radius:5px; cursor:pointer; font-weight:500;">Escolher arquivo</label>
      <input type="file" id="excelFile" accept=".xlsx, .xls" style="display:none;">
      <button onclick="importExcel()" style="background:#2563eb; color:white; padding:8px 12px; border:none; border-radius:5px; cursor:pointer; font-weight:500;">Importar Excel</button>
      <button onclick="exportClientesToCSV()" style="background:#2563eb; color:white; padding:8px 12px; border:none; border-radius:5px; cursor:pointer; font-weight:500;">Exportar CSV</button>
    </div>

    <div style="text-align:center; margin-bottom:10px;">
      <button onclick="openModal(null,false)" style="background:#2563eb; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; font-weight:500;">+ Adicionar Cliente</button>
    </div>

    <input type="text" id="searchClientes" placeholder="Pesquisar clientes..." oninput="renderClientes()">

    <table>
      <thead>
        <tr>
          <th>Organiza√ß√£o</th>
          <th>Coluna</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="clientesTableBody"></tbody>
    </table>
  </div>
</div>

<div id="modal">
  <div id="modalContent">
    <h3 id="modalTitle">Novo Cliente</h3>
    <input type="text" id="clientName" placeholder="Organiza√ß√£o">
    <input type="text" id="clientMembers" placeholder="Integrantes">
    <input type="date" id="clientStart" placeholder="Data de in√≠cio">
    <input type="date" id="clientEnd" placeholder="Data Go live">
    <textarea id="clientTickets" placeholder="Tickets"></textarea>
    <textarea id="clientObservacoes" placeholder="Observa√ß√µes"></textarea>
    <textarea id="clientTratativa" placeholder="Tratativa"></textarea>
    <select id="clientReuniao">
      <option value="">Reuni√£o marcada?</option>
      <option>Sim</option>
      <option>N√£o</option>
    </select>
    <input type="date" id="clientDataReuniao" placeholder="Data reuni√£o">
    <select id="clientDivergenciaComercial">
      <option value="">Diverg√™ncia Comercial?</option>
      <option>Sim</option>
      <option>N√£o</option>
    </select>
    <select id="clientAtrasoImplantacao">
      <option value="">Atraso implanta√ß√£o?</option>
      <option>Sim</option>
      <option>N√£o</option>
    </select>
    <input type="text" id="clientImplantador" placeholder="Implantador">
    <select id="clientColuna">
      <option value="">Sem coluna</option>
      <option value="risco">Risco de Cancelamento</option>
      <option value="critico">Cr√≠ticos</option>
      <option value="duvidas">D√∫vidas</option>
    </select>
    <button onclick="saveClient(currentIsCard)">Salvar</button>
    <button onclick="closeModal()">Cancelar</button>
  </div>
</div>

<script>
// --- JS permanece igual ao seu c√≥digo original ---
// Carregamento, renderiza√ß√£o, salvar, editar, excluir, importar/exportar...
let clients = JSON.parse(localStorage.getItem("kanbanClients") || "[]");
let editingClient = null;
let currentIsCard = true;

function showModule(module){
  document.getElementById('cardsModule').style.display = module==='cards'? 'block':'none';
  document.getElementById('clientesModule').style.display = module==='clientes'? 'block':'none';
  renderKanban();
  renderClientes();
}

function openModal(client=null,isCard=true){
  editingClient = client;
  currentIsCard = isCard;
  document.getElementById("modal").style.display="flex";
  document.getElementById("modalTitle").innerText = client ? "Editar Cliente" : "Novo Cliente";
  ["clientName","clientMembers","clientStart","clientEnd","clientTickets","clientObservacoes","clientTratativa","clientReuniao","clientDataReuniao","clientDivergenciaComercial","clientAtrasoImplantacao","clientImplantador","clientColuna"].forEach(id=>{
    document.getElementById(id).value = client?.[id] || "";
  });
}

function closeModal(){ document.getElementById("modal").style.display="none"; editingClient = null; }

function saveClient(isCard){
  const clientData = {
    id: editingClient?.id || Date.now().toString(),
    clientName: document.getElementById("clientName").value,
    clientMembers: document.getElementById("clientMembers").value,
    clientStart: document.getElementById("clientStart").value,
    clientEnd: document.getElementById("clientEnd").value,
    clientTickets: document.getElementById("clientTickets").value,
    clientObservacoes: document.getElementById("clientObservacoes").value,
    clientTratativa: document.getElementById("clientTratativa").value,
    clientReuniao: document.getElementById("clientReuniao").value,
    clientDataReuniao: document.getElementById("clientDataReuniao").value,
    clientDivergenciaComercial: document.getElementById("clientDivergenciaComercial").value,
    clientAtrasoImplantacao: document.getElementById("clientAtrasoImplantacao").value,
    clientImplantador: document.getElementById("clientImplantador").value,
    clientColuna: document.getElementById("clientColuna").value
  };
  if(editingClient){
    const index = clients.findIndex(c => c.id === clientData.id);
    if(index !== -1) clients[index] = clientData;
  } else { clients.push(clientData); }
  localStorage.setItem("kanbanClients", JSON.stringify(clients));
  closeModal(); renderKanban(); renderClientes();
}

function deleteClient(id){
  if(confirm("Deseja realmente excluir este cliente?")){
    clients = clients.filter(c=>c.id!==id);
    localStorage.setItem("kanbanClients", JSON.stringify(clients));
    renderKanban(); renderClientes();
  }
}

function renderKanban(){
  const searchTerm = document.getElementById("searchInput")?.value.toLowerCase() || "";
  ["risco","critico","duvidas"].forEach(col=>{
    const column = document.getElementById(col);
    const title = column.querySelector('h2').innerText;
    column.innerHTML = `<h2>${title}</h2>`;
    column.addEventListener("dragover", e => e.preventDefault());
    column.addEventListener("drop", e => {
      e.preventDefault();
      const cardId = e.dataTransfer.getData("text/plain");
      const card = clients.find(c=>c.id===cardId);
      if(card){ card.clientColuna = col; localStorage.setItem("kanbanClients", JSON.stringify(clients)); renderKanban(); renderClientes(); }
    });
  });
  clients.filter(c=>c.clientColuna).filter(client => {
    const values = [client.clientName, client.clientMembers, client.clientTickets, client.clientObservacoes, client.clientTratativa, client.clientImplantador].join(" ").toLowerCase();
    return values.includes(searchTerm);
  }).forEach(client=>{
    const card = document.createElement("div");
    card.className="card"; card.dataset.id = client.id; card.draggable = true;
    card.innerHTML = `
      <strong>${client.clientName}</strong>
      <div class="details">
        <p><b>Integrantes:</b> ${client.clientMembers||"-"}</p>
        <p><b>Per√≠odo:</b> ${client.clientStart||"-"} ‚Üí ${client.clientEnd||"-"}</p>
        <p><b>Tickets:</b> ${client.clientTickets||"-"}</p>
        <p><b>Observa√ß√µes:</b> ${client.clientObservacoes||"-"}</p>
        <p><b>Tratativa:</b> ${client.clientTratativa||"-"}</p>
        <p><b>Reuni√£o marcada:</b> ${client.clientReuniao||"-"}</p>
        <p><b>Data reuni√£o:</b> ${client.clientDataReuniao||"-"}</p>
        <p><b>Diverg√™ncia Comercial:</b> ${client.clientDivergenciaComercial||"-"}</p>
        <p><b>Atraso Implanta√ß√£o:</b> ${client.clientAtrasoImplantacao||"-"}</p>
        <p><b>Implantador:</b> ${client.clientImplantador||"-"}</p>
      </div>
      <button class="toggleBtn">Mostrar mais</button>
      <button class="editBtn">Editar</button>
      <button class="deleteBtn">Excluir</button>
    `;
    card.addEventListener("dragstart", e => { e.dataTransfer.setData("text/plain", client.id); card.classList.add("dragging"); });
    card.addEventListener("dragend", e => card.classList.remove("dragging"));
    card.querySelector(".toggleBtn").addEventListener("click", ()=>{
      const d = card.querySelector(".details");
      d.style.display = d.style.display==="none"?"block":"none";
      card.querySelector(".toggleBtn").innerText = d.style.display==="none"?"Mostrar mais":"Mostrar menos";
    });
    card.querySelector(".editBtn").addEventListener("click",()=>openModal(client,true));
    card.querySelector(".deleteBtn").addEventListener("click",()=>deleteClient(client.id));
    const columnEl = document.getElementById(client.clientColuna);
    if(columnEl) columnEl.appendChild(card);
  });
}

function renderClientes(){
  const searchTerm = document.getElementById("searchClientes")?.value.toLowerCase() || "";
  const tbody = document.getElementById("clientesTableBody");
  tbody.innerHTML = "";
  clients.filter(client => [client.clientName].join(" ").toLowerCase().includes(searchTerm))
    .forEach(client=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${client.clientName}</td>
        <td>
          <select onchange="updateClientColuna('${client.id}',this.value)">
            <option value="" ${client.clientColuna===""?"selected":""}>Sem coluna</option>
            <option value="risco" ${client.clientColuna==="risco"?"selected":""}>Risco de Cancelamento</option>
            <option value="critico" ${client.clientColuna==="critico"?"selected":""}>Cr√≠ticos</option>
            <option value="duvidas" ${client.clientColuna==="duvidas"?"selected":""}>D√∫vidas</option>
          </select>
        </td>
        <td>
          <button onclick="openModal(clients.find(c=>c.id==='${client.id}'),false)">Editar</button>
          <button onclick="deleteClient('${client.id}')">Excluir</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
}

function updateClientColuna(id,value){
  const client = clients.find(c=>c.id===id);
  if(client){ client.clientColuna = value; localStorage.setItem("kanbanClients", JSON.stringify(clients)); renderKanban(); renderClientes(); }
}

function exportKanbanToCSV(){
  const filtered = clients.filter(c => c.clientColuna && c.clientColuna.toString().trim() !== "");
  if(filtered.length === 0){
    alert("Nenhum card para exportar!");
    return;
  }
  exportClientsCSV(filtered, "cards");
}

function exportClientesToCSV(){
  if(!clients || clients.length === 0){
    alert("Nenhum cliente para exportar!");
    return;
  }
  exportClientsCSV(clients, "clientes");
}

function exportClientsCSV(list, filename){
  const headers = ["Organiza√ß√£o","Integrantes","Data In√≠cio","Data Go Live","Tickets","Observa√ß√µes","Tratativa","Reuni√£o","Data Reuni√£o","Diverg√™ncia Comercial","Atraso Implanta√ß√£o","Implantador","Coluna"];
  const csvRows = [headers.join(";")];

  list.forEach(c => {
    // monta a linha garantindo que cada campo seja string e escapando aspas
    const row = [
      c.clientName,
      c.clientMembers,
      c.clientStart,
      c.clientEnd,
      c.clientTickets,
      c.clientObservacoes,
      c.clientTratativa,
      c.clientReuniao,
      c.clientDataReuniao,
      c.clientDivergenciaComercial,
      c.clientAtrasoImplantacao,
      c.clientImplantador,
      c.clientColuna
    ].map(v => {
      const safe = String(v === undefined || v === null ? "" : v);
      return `"${safe.replace(/"/g, '""')}"`;
    }).join(";");
    csvRows.push(row);
  });

  const blob = new Blob([csvRows.join("\r\n")], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename + ".csv";
  document.body.appendChild(a); // some browsers need it in DOM
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}


function importExcel() {
  const fileInput = document.getElementById("excelFile");
  if (!fileInput.files.length) { alert("Selecione um arquivo Excel ou CSV!"); return; }
  const file = fileInput.files[0];
  const reader = new FileReader();

  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
    const rawJsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: "" });
    const jsonData = rawJsonData.map(row => {
      const normalizedRow = {};
      for (let key in row) {
        const newKey = key.normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
        normalizedRow[newKey] = row[key];
      }
      return normalizedRow;
    });
    jsonData.forEach(row => {
      const clientData = {
        id: Date.now().toString() + Math.random(),
        clientName: row["Organiza√ß√£o"] || row["Organizacao"] || row["Organiza√ßao"] || row[Object.keys(row)[0]] || "",
        clientMembers: row["Integrantes"] || "",
        clientStart: row["Data Inicio"] || "",
        clientEnd: row["Data Go Live"] || "",
        clientTickets: row["Tickets"] || "",
        clientObservacoes: row["Observacoes"] || "",
        clientTratativa: row["Tratativa"] || "",
        clientReuniao: row["Reuniao"] || "",
        clientDataReuniao: row["Data Reuniao"] || "",
        clientDivergenciaComercial: row["Divergencia Comercial"] || "",
        clientAtrasoImplantacao: row["Atraso Implantacao"] || "",
        clientImplantador: row["Implantador"] || "",
        clientColuna: row["Coluna"] || ""
      };
      clients.push(clientData);
    });

    localStorage.setItem("kanbanClients", JSON.stringify(clients));
    renderClientes();
    renderKanban();
    alert("Clientes importados com sucesso!");
  };

  reader.readAsArrayBuffer(file);
}

// Inicializa m√≥dulos
showModule('cards');
</script>

</body>
</html>
